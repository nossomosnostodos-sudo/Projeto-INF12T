import sqlite3
import getpass

DB_NAME = "biblioteca.db"

def conectar():
    return sqlite3.connect(DB_NAME)

def criar_tabela_usuarios():
    con = conectar()
    cur = con.cursor()
    cur.execute("""
        CREATE TABLE IF NOT EXISTS Usuarios(
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            nome TEXT,
            email TEXT UNIQUE NOT NULL,
            senha TEXT NOT NULL
        );
    """)
    con.commit()
    con.close()

def cadastrar_usuario(nome, email, senha):
    con = conectar()
    cur = con.cursor()
    try:
        cur.execute("INSERT INTO Usuarios (nome, email, senha) VALUES (?, ?, ?)", (nome, email, senha))
        con.commit()
        print("Conta criada com sucesso!")
    except sqlite3.IntegrityError:
        print("Erro: Email já cadastrado.")
    finally:
        con.close()

def verificar_login(email, senha):
    con = conectar()
    cur = con.cursor()
    cur.execute("SELECT * FROM Usuarios WHERE email = ? AND senha = ?", (email, senha))
    usuario = cur.fetchone()
    con.close()
    return usuario

def main():
    criar_tabela_usuarios()
    while True:
        print("\n=== MENU ===")
        print("1 - Login")
        print("2 - Criar conta")
        print("0 - Sair")
        escolha = input("Escolha: ").strip()

        if escolha == "1":
            email = input("Email: ").strip()
            senha = getpass.getpass("Senha: ").strip()  # oculta senha digitada
            usuario = verificar_login(email, senha)
            if usuario:
                print(f"Login bem-sucedido! Bem vindo(a), {usuario[1] or 'Usuário'}!")
                # Aqui você pode chamar sua função principal da biblioteca
            else:
                print("Email ou senha incorretos!")

        elif escolha == "2":
            nome = input("Nome/apelido (opcional): ").strip()
            email = input("Email: ").strip()
            senha = getpass.getpass("Senha (8 dígitos ou mais): ").strip()

            if len(senha) < 8:
                print("Erro: A senha deve ter no mínimo 8 caracteres.")
                continue

            cadastrar_usuario(nome, email, senha)

        elif escolha == "0":
            print("Saindo...")
            break
        else:
            print("Opção inválida. Tente novamente.")

if __name__ == "__main__":
    main()
